# GoUp 积分支付抵扣规则规范

本文档定义“积分支付”的固定抵扣档位、支付组合计算、余额校验与退款约定（退款仅退现金，积分不退回），确保前后端一致实现与测试。

## 固定抵扣档位

积分抵扣在订单页提供 6 个固定档位，按人民币抵扣金额与所需积分一一对应：

- 1000 积分 → 抵扣 1 元
- 5000 积分 → 抵扣 5 元
- 10000 积分 → 抵扣 10 元
- 15000 积分 → 抵扣 15 元
- 20000 积分 → 抵扣 20 元
- 50000 积分 → 抵扣 50 元

说明：
- 档位为固定集合，不随活动分类或比例变化；订单金额以整数（元）计价。
- 每笔订单仅可选择一个档位进行抵扣；不可叠加多个档位。

## 支付组合与计算

- 输入：订单金额 `amount`（整数元）、所选积分抵扣档位对应的抵扣金额 `deductYuan`、用户积分余额 `pointsBalance`、该档位所需积分 `requiredPoints`。
- 余额校验：`pointsBalance >= requiredPoints` 才允许选择该档位；否则禁用或提示“积分不足”。
- 现金应付：`cashPayable = max(amount - deductYuan, 0)`。
- 仅积分支付：当 `deductYuan >= amount` 时，`cashPayable = 0`，可不经微信/支付宝，仅使用积分完成支付。
- 合并支付：当 `deductYuan < amount` 时，现金支付金额为 `cashPayable`，现金方式可选择微信或支付宝。

## 退款与取消

- 活动开始前取消报名：不产生活动积分或裂变积分；若该订单使用了积分抵扣且已扣减成功，后续取消或退款仅退回现金支付金额，积分不退回。
- 订单退款（活动结束后因异常或用户维权）：按业务规则处理现金退款；积分部分不返还；不生成积分返还流水。

## 记录与流水

- 积分账户流水：选择抵扣档位时记一笔 `type=spend, sourceType=payment`，金额为负积分 `-requiredPoints`；退款或取消不产生积分返还流水（仅现金退款）。
- 幂等处理：每笔订单抵扣需与 `orderId` 绑定唯一键，重复调用不重复扣减。

## 接口建议

- 预下单：`POST /api/payments/prepay`
  - 请求：`{ orderId, amount, payMethod:"wechat|alipay|points_only", pointsTierId?: "TIER_1|...", deductYuan?: number }`
  - 响应：`{ orderId, finalPayable, requiredPoints, canPointsOnly }`
- 回调与退款：在现有支付回调与退款流程中增加积分扣减的幂等逻辑；退款仅退现金，积分不返还。

## 示例

- 示例一：订单金额 19 元，选择 5 元档位（5000 积分）
  - 余额充足 → `cashPayable=14`；用户使用微信或支付宝支付 14 元，积分扣减 5000。
- 示例二：订单金额 15 元，选择 20 元档位（20000 积分）
  - 余额充足 → `cashPayable=0`；仅积分支付；扣减 20000 积分。
- 示例三：余额不足
  - 用户余额 8000 积分，尝试选择 10000 积分档位 → 禁用或提示“积分不足”。