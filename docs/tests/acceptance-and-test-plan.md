# 验收用例与测试计划

本文档覆盖三个里程碑的验收标准、测试用例、数据准备与自动化建议：
1. 支付回调与退款通知
2. 统一分页/搜索
3. 积分支付规则计算

## 1. 支付回调与退款通知

### 验收标准
- 预支付成功返回 `prepayId` 与 `signature`，签名可被前端/小程序使用。
- 渠道回调验签与金额匹配正确；重复回调不重复入账（幂等）。
- 订单状态正确更新（`paid`/`refunded`）；支付与退款流水记录完整。
- 异常回调被写入 `payment_errors` 并可在 Admin 端筛选分页查看。
- 用户/管理员通知触发符合事件：报名成功、退款到账、异常支付。

### 测试用例
- 用例 P1：微信支付成功回调 → 订单 `created` → `paid`，记录支付流水。
- 用例 P2：支付宝支付成功回调 → 幂等重放 3 次 → 仍仅 1 笔入账。
- 用例 P3：金额不匹配 → 验签失败 → 记录 `payment_errors` 并返回失败。
- 用例 P4：用户取消报名（活动未开始）→ 发起退款 → 渠道回调到账 → 订单 `refunded`。
- 用例 P5：管理员主动退款接口 → 记录退款流水 → 失败重试与错误提示。
- 用例 P6：通知：支付成功/退款到账模板消息发送（可模拟/打桩）。

### 数据准备
- `seed.js` 增加：`orders`（`created` 状态）与相应 `payments` 记录；生成若干 `orderId` 用于模拟。

### 自动化建议
- 接口层使用 API 测试（如 `supertest`）模拟渠道回调负载。
- 幂等性用随机/固定回调 ID 重放多次验证唯一约束与状态机。

## 2. 统一分页/搜索

### 验收标准
- 所有目标列表端点支持 `page/pageSize/sortBy/sortOrder/keyword/start/end`。
- 返回统一结构：`{ total, items, page, pageSize }`；极端条件下（空/超页）行为正确。
- Admin 前端在筛选/翻页时触发服务端请求，组件显示与交互一致。

### 测试用例
- 用例 P1：`/api/payments/errors` 按 `provider=wechat`、`keyword` 模糊匹配分页返回正确。
- 用例 P2：非法 `pageSize=0` 返回 `400` 错误码。
- 用例 P3：`start>end` 返回 `400` 错误码；无数据时返回空 `items` 与 `total=0`。
- 用例 P4：`orders`/`payments` 列表（改造后）在排序与搜索下结果稳定。

### 自动化建议
- 针对分页查询的 SQL 构造进行单元与集成测试，覆盖排序与时间范围。

## 3. 积分支付规则计算

### 验收标准
- 不同活动分类命中对应抵扣比例；满额限制生效；单次限用规则生效。
- 计算结果一致：`finalPayable = amount - deduct`，不出现负数或超扣。
- 赠送规则：基础/阶梯/特殊活动双倍逻辑正确；回滚策略在退款场景可选生效。

### 测试用例
- 用例 P1：志愿活动 300 元、余额 200、上限 50% → 抵扣 150，应付 150。
- 用例 P2：主题活动 180 元、满额 200 → 不可用券 → 抵扣 0，应付 180。
- 用例 P3：余额导致超过上限 → 返回 `POINTS_EXCEED_RATIO`。
- 用例 P4：赠送：满 250 元命阶梯 8:1 且双倍 → 赠送 62。

### 自动化建议
- 抽象 `pointsPaymentService` 的纯函数计算层，进行参数化单元测试（边界/异常）。

## 回归与观察性

- 日志：为回调与退款流程记录关键字段与处理结果（脱敏）。
- 指标：支付成功率、退款失败率、错误分类统计；异常趋势监控与告警。